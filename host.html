<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
  </head>
  <body>
		<progress id="sendProgress" max="0" value="0"></progress>
    <div id="MONITER" style="position: relative; width: 700px; height: 350px; overflow: scroll; border: 1px solid green;">
    </div>

    <div id="IMGS" style="border: 2px solid red">
    </div>

    <button id="ready">READY</button>

    <div id="VIDEOS" style="border: 2px solid red">
    </div>

    <script src="dist/javascripts/socket.io.js"></script>
    <script src="dist/javascripts/jrtc.bundle.js"></script>
    <script>


    const {desktopCapturer, screen} =  require('electron');
    const robot = require("robotjs");
    robot.setMouseDelay(1);
    robot.setKeyboardDelay(1);


    let screens = screen.getAllDisplays();

    let screenOption = {};


    document.getElementById("ready").addEventListener('click', function() {
      getStreamReady();
    });


    screens.forEach(function(info) {
      console.log(info.bounds.width);
      console.log(info.bounds.height);
      console.log(info.bounds.x);
      console.log(info.bounds.y);

      let moniter = document.getElementById("MONITER");
      let div = document.createElement("div");

      div.style.position = "absolute";
      div.style.width  =  parseInt(info.bounds.width / 8)+"px";
      div.style.height =  parseInt(info.bounds.height / 8)+"px";

      div.style.left =  parseInt(info.bounds.x / 8)+"px";
      div.style.top  =  parseInt(info.bounds.y / 8)+"px";

      div.style.border = "1px solid #000";

      div.addEventListener('dragover', function(event) {
        event.preventDefault();
      });

      div.addEventListener("drop", function(event) {
        console.log('drop', event);

        //dataTransfer 객체로 부터 데이터를 꺼내옴
        var id = event.dataTransfer.getData("target");
        var optionElement = document.getElementById(id);
        optionElement.parentNode.removeChild(optionElement);
        optionElement.style.width = "100%";

        screenOption[id] = {
          "width": info.bounds.width,
          "height": info.bounds.height,
          "x": info.bounds.x,
          "y": info.bounds.y
        }


        event.currentTarget.appendChild(optionElement);
        event.preventDefault();
      });


      moniter.appendChild(div);

    });

    let screenSize = screen.getPrimaryDisplay().size;

    let socketUrl = 'https://superlucky.co.kr:12341';
    //let socketUrl = 'http://localhost:12341';

    let receiver = {};
    let sourcesInfo = null;

    let sender = {
      'screen-main': null
    };


    desktopCapturer.getSources({types: ['screen']}, (error, sources) => {

      let IMGS = document.getElementById("IMGS");

      sourcesInfo = sources;

      sources.forEach(function(source) {

        let imgUrl = source.thumbnail.toDataURL();
        let img = document.createElement("img");

        img.src = imgUrl;
        img.style.width = "100px";
        img.style.marginRight = "10px";
        img.setAttribute("dragable","true");

        img.id = source.id;

        img.addEventListener("dragstart", function(event) {
          event.dataTransfer.setData("target", event.target.id);
        });

        IMGS.appendChild(img);
      });



    });



    function createSender(socketUrl, channleType, length) {

      let videoElement = document.createElement("video");

      videoElement.style.width = parseInt(100/length)+"%";

      let $VIDEOS = document.getElementById('VIDEOS');
      $VIDEOS.appendChild(videoElement);


      let sender = new Jrtc(
          'sender',
          channleType, //all or screen
          io.connect(socketUrl),
          videoElement
      );

      return sender;

    }


    function getStreamReady() {
      let sources = sourcesInfo;

      sources.forEach(function(source) {
        console.log(source);

        

        navigator.webkitGetUserMedia({
          audio: false,
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: source.id,
              minWidth: screenOption[source.id].width,
              maxWidth: screenOption[source.id].width,
              minHeight: screenOption[source.id].height,
              maxHeight: screenOption[source.id].height
            }
          }
        },
        function(sourceId, stream) {

          console.log("STREAM",sourceId,stream);

          if (sender['screen-main'] == null) {
            sender['screen-main'] = createSender(socketUrl, 'all', sources.length);
            sender['screen-main'].setEvent(stream, screenOption[sourceId]);
            sender['screen-main'].receiveCreateRtc = receiveCreateRtc;

            sender['screen-main'].join('screen-main', function(receveirIds) {
              receveirIds.forEach(function(id) {
                sender['screen-main'].createPeer(id);
                sender['screen-main'].createOffer(id);
              });
            });

          }
          else {
            sender['screen-main'].streamIds.push(stream.id);

            sender['screen-sub-'+stream.id] = createSender(socketUrl, 'screen', sources.length);
            sender['screen-sub-'+stream.id].setEvent(stream, screenOption[sourceId]);

            sender['screen-sub-'+stream.id].join('screen-sub-'+stream.id, function(receveirIds) {
              receveirIds.forEach(function(id) {
                sender['screen-sub-'+stream.id].createPeer(id);
                sender['screen-sub-'+stream.id].createOffer(id);
              });
            });
          }
        }.bind(this, source.id), 
        handleError);
      });


    }




    function receiveCreateRtc(id, roomname) {

      receiver[id] = new Jrtc( 'receiver', 'data', io.connect(socketUrl));


      // join 을 하면 센더에서 크레이트 피어를 합니다.
      receiver[id].join(roomname);

      let mouseDown = false;

      receiver[id].onReceiveMessageCallback = function(event) {
        let data = JSON.parse(event.data);

        console.log("va-",data);
        let option = [];




        if (data.isShift) option.push('shift');
        if (data.isCtrl) option.push('control');

        if (data.key == 'w' && data.isShift) {
          option = ['control'];
        }


        if (data.topic == 'KeyMouseCtrl:KeyEvent') {
          robot.keyToggle(
              data.key, 
              (data.down==1)?'down':'up',
              option
          );
        }


        if (data.topic == 'KeyMouseCtrl:MouseEvent') {
          robot.moveMouse(data.x, data.y);

          if (!mouseDown && data.buttonMask == 1) {
            robot.mouseToggle("down");
            mouseDown = true;
          }

          if (mouseDown) {
            robot.dragMouse(data.x,data.y);
          }

          if (mouseDown && data.buttonMask == 0) {
            mouseDown = false;
          }

          if (data.buttonMask == 0)  {
            robot.mouseToggle("up");
          }
        }
      }
    }

    function handleError (e) {
      console.log(e)
    }



    </script>
  </body>
</html>

